http:
  middlewares:
    # Authentication middleware - validates JWT tokens
    auth-middleware:
      forwardAuth:
        address: "http://auth_service:8000/auth/verify"
        trustForwardHeader: true
        authResponseHeaders:
          - "X-User-ID"
          - "X-User-Email"
          - "X-User-Roles"
          - "X-User-Active"

    # Rate limiting - 100 requests per minute per user
    rate-limit:
      rateLimit:
        burst: 100
        average: 10  # 10 requests per second

    # CORS configuration
    cors-headers:
      headers:
        accessControlAllowOriginList:
          - "*"
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "DELETE"
          - "OPTIONS"
        accessControlAllowHeaders:
          - "Content-Type"
          - "Authorization"
          - "X-Requested-With"
        accessControlMaxAge: 86400

    # Security headers
    security-headers:
      headers:
        customResponseHeaders:
          X-Frame-Options: "DENY"
          X-Content-Type-Options: "nosniff"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"
          Permissions-Policy: "geolocation=(), microphone=(), camera=()"

    # Request size limit - 50MB for file uploads
    request-size-limit:
      buffering:
        maxRequestBodyBytes: 52428800  # 50MB
        memRequestBodyBytes: 134217728  # 128MB
        maxResponseBodyBytes: 52428800  # 50MB

  routers:
    # Frontend routes (no auth required)
    frontend:
      rule: "Host(`localhost`)"
      service: frontend
      middlewares:
        - cors-headers
        - security-headers

    # Auth service routes (login/register don't need auth)
    auth-public:
      rule: "Host(`localhost`) && (PathPrefix(`/auth/login`) || PathPrefix(`/auth/register`))"
      service: auth_service
      middlewares:
        - cors-headers
        - security-headers
        - rate-limit

    # Protected auth routes
    auth-protected:
      rule: "Host(`localhost`) && PathPrefix(`/auth/`)"
      service: auth_service
      middlewares:
        - auth-middleware
        - cors-headers
        - security-headers
        - rate-limit

    # Data management service
    data-management:
      rule: "Host(`localhost`) && PathPrefix(`/datasets`)"
      service: data_management_service
      middlewares:
        - auth-middleware
        - cors-headers
        - security-headers
        - request-size-limit
        - rate-limit

    # Job orchestration service
    job-orchestration:
      rule: "Host(`localhost`) && PathPrefix(`/jobs`)"
      service: job_orchestration_service
      middlewares:
        - auth-middleware
        - cors-headers
        - security-headers
        - rate-limit

    # Reporting service
    reporting:
      rule: "Host(`localhost`) && PathPrefix(`/reports`)"
      service: reporting_service
      middlewares:
        - auth-middleware
        - cors-headers
        - security-headers
        - rate-limit

    # Active experiment service
    active-experiment:
      rule: "Host(`localhost`) && PathPrefix(`/active-experiments`)"
      service: active_experiment_service
      middlewares:
        - auth-middleware
        - cors-headers
        - security-headers
        - rate-limit

    # PDE discovery service
    pde-discovery:
      rule: "Host(`localhost`) && PathPrefix(`/pde-discovery`)"
      service: pde_discovery_service
      middlewares:
        - auth-middleware
        - cors-headers
        - security-headers
        - rate-limit

    # PINN training service
    pinn-training:
      rule: "Host(`localhost`) && PathPrefix(`/pinn-training`)"
      service: pinn_training_service
      middlewares:
        - auth-middleware
        - cors-headers
        - security-headers
        - rate-limit

    # Derivative feature service
    derivative-feature:
      rule: "Host(`localhost`) && PathPrefix(`/derivatives`)"
      service: derivative_feature_service
      middlewares:
        - auth-middleware
        - cors-headers
        - security-headers
        - rate-limit

  services:
    frontend:
      loadBalancer:
        servers:
          - url: "http://frontend:80"

    auth_service:
      loadBalancer:
        servers:
          - url: "http://auth_service:8000"

    data_management_service:
      loadBalancer:
        servers:
          - url: "http://data_management_service:8001"

    job_orchestration_service:
      loadBalancer:
        servers:
          - url: "http://job_orchestration_service:8002"

    reporting_service:
      loadBalancer:
        servers:
          - url: "http://reporting_service:8003"

    active_experiment_service:
      loadBalancer:
        servers:
          - url: "http://active_experiment_service:8004"

    pde_discovery_service:
      loadBalancer:
        servers:
          - url: "http://pde_discovery_service:8005"

    pinn_training_service:
      loadBalancer:
        servers:
          - url: "http://pinn_training_service:8006"

    derivative_feature_service:
      loadBalancer:
        servers:
          - url: "http://derivative_feature_service:8007"